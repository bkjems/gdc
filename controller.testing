import unittest
import json
import time
import datetime

# This is the class we want to test. So, we need to import it
import controller as ControllerClass 

class Test(unittest.TestCase):

    def setup(self):
        config_file = open('config.json')
        c = ControllerClass.Controller(json.load(config_file), True) 
        config_file.close()
	c.from_time = ""
        c.to_time = ""
        c.on_days_of_week = ""
 	c.time_to_open = 0	
	return c

    def testDoorOpenLongerThanTTW(self):
	c = self.setup() 
	door = c.getDoor("right")
	c.time_to_report_open= 1
	c.time_to_close = 0
	c.toggle(door.id)
	c.check_status() 
	time.sleep(4)
	c.check_status() 
        self.assertFalse(door.send_open_im)

    def testOpenNoApproxTimeInOpen(self):
	c = self.setup() 
	door = c.getDoor("left")
	c.time_to_open = 0
	c.toggle(door.id)
	time.sleep(2)
	c.check_status()
        self.assertEquals(door.state, "open")

    def testOpenCloseNoApproxTimeInClose(self):
	c = self.setup() 
	door = c.getDoor("right")
	c.time_to_close= 0
	c.time_to_open = 0

	c.toggle(door.id)
	c.check_status()
        self.assertEquals(door.state, "open")

	c.toggle(door.id)
	c.check_status()
        self.assertEquals(door.state, "closed")

    def testOpeningWithApproxTimeToOpen(self):
	c = self.setup() 
	door = c.getDoor("left")
	door.state = "closed" 
	c.time_to_open=5
	c.toggle(door.id)
	c.check_door_status(door)
        self.assertEquals(door.state, "opening")
 
    def testClosingWithApproxTimeToClose(self):
	c = self.setup() 
	door = c.getDoor("left")
	door.state = "open"
	door.test_state_pin= "open"
	door.time_to_close= 5
	c.toggle(door.id)
	c.check_door_status(door)
        self.assertEquals(door.state, "closing")

    def testGetDoor(self):
	c = self.setup() 
	door = c.getDoor("left")
        self.assertTrue(door.id == "left")
	door = c.getDoor("right")
        self.assertTrue(door.id == "right")
#date
    def testIsDayOfWeekInvalid(self):
        c = self.setup()
        c.on_days_of_week="Mon,Tue,Wed,Thu,Fri,Sun"
        dow = datetime.date(2018, 11, 17).weekday()
        rv = c.is_day_of_week(dow)
        self.assertFalse(rv)

    def testIsDayOfWeekValid(self):
        c = self.setup()
        c.on_days_of_week="Mon,Tue,Wed,Thu,Fri,Sat,Sun"
        #dow = datetime.datetime.now().weekday()
        dow = datetime.date(2018, 11, 17).weekday()
        rv = c.is_day_of_week(dow)
        self.assertTrue(rv)

    def testIsDayOfWeekEmpty(self):
        c = self.setup()
        c.on_days_of_week=""
        dow = datetime.date(2018, 11, 17).weekday()
        rv = c.is_day_of_week(dow)
        self.assertTrue(rv)

    def testIsTimeBetweenParamsEmpty(self):
        c = self.setup()
        c.from_time = ""
        c.to_time = ""
        c.on_days_of_week = ""
        rv = c.is_time_between(datetime.time(5, 0))
        self.assertTrue(rv)

    def testIsTimeBetweenValid(self):
        c = self.setup()
        c.from_time = '00:00'
        c.to_time = '23:59'
        rv = c.is_time_between(datetime.time(2, 0))
        self.assertTrue(rv)

    def testIsTimeBetweenInvalid(self):
        c = self.setup()
        c.from_time = '00:01'
        c.to_time = '02:00'
        rv = c.is_time_between(datetime.time(2, 2))
        self.assertFalse(rv)

    def testIsTimeBetween0000_2359Valid(self):
        c = self.setup()
        c.from_time = '00:01'
        c.to_time = '23:59'
        rv = c.is_time_between(datetime.time(3,1))
        self.assertTrue(rv)

if __name__ == '__main__':
    # begin the unittest.main()
    unittest.main()

